<!DOCTYPE html>
<html lang="zh-CN">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>403错误快速修复</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
                background: #1a1a1a;
                color: #fff;
            }

            .fix-section {
                background: #2a2a2a;
                padding: 20px;
                margin: 20px 0;
                border-radius: 8px;
                border: 1px solid #333;
            }

            .success {
                color: #28a745;
            }

            .error {
                color: #dc3545;
            }

            .warning {
                color: #ffc107;
            }

            .info {
                color: #17a2b8;
            }

            button {
                background: #007bff;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 4px;
                cursor: pointer;
                margin: 5px;
            }

            button:hover {
                background: #0056b3;
            }

            .solution {
                background: #1e3a5f;
                padding: 15px;
                border-radius: 5px;
                margin: 10px 0;
                border-left: 4px solid #007bff;
            }
        </style>
    </head>

    <body>
        <h1>🔧 403错误快速修复</h1>

        <div class="fix-section">
            <h2>🚨 问题诊断</h2>
            <p class="error">您遇到的403错误通常表示以下问题之一：</p>
            <ul>
                <li>API Key无效或已过期</li>
                <li>API Key权限不足</li>
                <li>订阅计划问题</li>
                <li>请求格式错误</li>
            </ul>
        </div>

        <div class="fix-section">
            <h2>🔑 解决方案</h2>

            <div class="solution">
                <h3>1. 检查API Key</h3>
                <p>当前API Key: <code>2c318d13-0557-47a3-a5c2-93afdf223408</code></p>
                <button onclick="testCurrentKey()">测试当前Key</button>
                <button onclick="testWithoutKey()">测试无Key请求</button>
            </div>

            <div class="solution">
                <h3>2. 尝试免费替代方案</h3>
                <p>如果API Key有问题，我们可以使用免费的替代数据源：</p>
                <button onclick="testAlternativeAPI()">测试替代API</button>
                <button onclick="switchToAlternative()">切换到替代方案</button>
            </div>

            <div class="solution">
                <h3>3. 修复建议</h3>
                <ul>
                    <li>登录 <a href="https://www.coinapi.io/" target="_blank" style="color: #007bff;">CoinAPI.io</a>
                        检查账户状态</li>
                    <li>确认API Key是否有效且未过期</li>
                    <li>检查订阅计划是否包含所需端点</li>
                    <li>联系CoinAPI.io客服获取新Key</li>
                </ul>
            </div>
        </div>

        <div class="fix-section">
            <h2>📊 测试结果</h2>
            <div id="results"></div>
        </div>

        <script>
            function log(message, type = 'info') {
                const results = document.getElementById('results');
                const timestamp = new Date().toLocaleTimeString();
                const className = type === 'success' ? 'success' :
                    type === 'error' ? 'error' :
                        type === 'warning' ? 'warning' : 'info';
                results.innerHTML += `<p class="${className}">[${timestamp}] ${message}</p>`;
                results.scrollTop = results.scrollHeight;
            }

            async function testCurrentKey() {
                log('测试当前API Key...', 'info');

                try {
                    const response = await fetch('https://rest.coinapi.io/v1/exchangerate/BTC/USDT', {
                        headers: {
                            'X-CoinAPI-Key': '2c318d13-0557-47a3-a5c2-93afdf223408',
                            'Accept': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        log(`✅ API Key有效！BTC价格: $${data.rate}`, 'success');
                    } else if (response.status === 403) {
                        log('❌ API Key无效 (403 Forbidden)', 'error');
                        log('💡 建议：检查CoinAPI.io账户状态或获取新Key', 'warning');
                    } else {
                        log(`❌ 请求失败: ${response.status}`, 'error');
                    }
                } catch (error) {
                    log(`❌ 网络错误: ${error.message}`, 'error');
                }
            }

            async function testWithoutKey() {
                log('测试无API Key的请求...', 'info');

                try {
                    const response = await fetch('https://rest.coinapi.io/v1/exchangerate/BTC/USDT');

                    if (response.status === 401) {
                        log('✅ 服务器正常，需要API Key认证', 'success');
                    } else {
                        log(`⚠️ 意外响应: ${response.status}`, 'warning');
                    }
                } catch (error) {
                    log(`❌ 网络连接失败: ${error.message}`, 'error');
                }
            }

            async function testAlternativeAPI() {
                log('测试免费替代API...', 'info');

                // 测试CoinGecko免费API
                try {
                    const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd');

                    if (response.ok) {
                        const data = await response.json();
                        log(`✅ CoinGecko API可用！BTC价格: $${data.bitcoin.usd}`, 'success');
                    } else {
                        log(`❌ CoinGecko API失败: ${response.status}`, 'error');
                    }
                } catch (error) {
                    log(`❌ CoinGecko API错误: ${error.message}`, 'error');
                }

                // 测试Binance API
                try {
                    const response = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT');

                    if (response.ok) {
                        const data = await response.json();
                        log(`✅ Binance API可用！BTC价格: $${data.price}`, 'success');
                    } else {
                        log(`❌ Binance API失败: ${response.status}`, 'error');
                    }
                } catch (error) {
                    log(`❌ Binance API错误: ${error.message}`, 'error');
                }
            }

            function switchToAlternative() {
                log('准备切换到替代数据源...', 'info');
                log('💡 建议使用Binance API作为替代方案', 'info');
                log('📝 需要修改index.html中的数据源配置', 'info');

                // 提供修复代码
                const fixCode = `
// 在index.html中替换CoinAPI.io配置为Binance API
const BINANCE_API_BASE = 'https://api.binance.com/api/v3';
const SUPPORTED_SYMBOLS = ['BTCUSDT', 'ETHUSDT', 'BNBUSDT', 'SOLUSDT'];

async function fetchBinancePrices() {
    try {
        const promises = SUPPORTED_SYMBOLS.map(symbol =>
            fetch(\`\${BINANCE_API_BASE}/ticker/price?symbol=\${symbol}\`)
        );

        const responses = await Promise.all(promises);
        const data = await Promise.all(responses.map(r => r.json()));

        return data.map(item => ({
            symbol: item.symbol,
            price: parseFloat(item.price),
            change_24h: Math.random() * 10 - 5 // 模拟24小时变化
        }));
    } catch (error) {
        console.error('Binance API错误:', error);
        return null;
    }
}
            `;

                log('🔧 修复代码:', 'info');
                log(`<pre>${fixCode}</pre>`, 'info');
            }

            // 页面加载时自动诊断
            window.addEventListener('load', () => {
                log('🔍 开始403错误诊断...', 'info');
                log('💡 建议先测试当前API Key，然后尝试替代方案', 'info');
            });
        </script>
    </body>

</html>
