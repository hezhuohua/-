<!DOCTYPE html>
<html lang="zh-CN">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>预测功能修复测试</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
                background: #f5f5f5;
            }

            .test-section {
                background: white;
                padding: 20px;
                margin: 20px 0;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            .status {
                padding: 10px;
                margin: 10px 0;
                border-radius: 4px;
                font-weight: bold;
            }

            .status.success {
                background: #d4edda;
                color: #155724;
            }

            .status.error {
                background: #f8d7da;
                color: #721c24;
            }

            .status.warning {
                background: #fff3cd;
                color: #856404;
            }

            .btn {
                padding: 10px 20px;
                margin: 5px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 16px;
            }

            .btn-primary {
                background: #007bff;
                color: white;
            }

            .btn-danger {
                background: #dc3545;
                color: white;
            }

            .btn-success {
                background: #28a745;
                color: white;
            }

            .log {
                background: #f8f9fa;
                border: 1px solid #dee2e6;
                padding: 10px;
                margin: 10px 0;
                border-radius: 4px;
                font-family: monospace;
                max-height: 300px;
                overflow-y: auto;
            }
        </style>
    </head>

    <body>
        <h1>🔧 预测功能修复测试</h1>

        <div class="test-section">
            <h2>📊 当前状态</h2>
            <div id="status" class="status warning">正在检测系统状态...</div>
            <div>
                <strong>预测状态:</strong> <span id="predictingStatus">检测中...</span><br>
                <strong>定时器状态:</strong> <span id="timerStatus">检测中...</span><br>
                <strong>预测数据:</strong> <span id="dataStatus">检测中...</span>
            </div>
        </div>

        <div class="test-section">
            <h2>🧪 测试功能</h2>
            <button class="btn btn-primary" onclick="testPrediction()">测试预测功能</button>
            <button class="btn btn-danger" onclick="forceReset()">强制重置状态</button>
            <button class="btn btn-success" onclick="checkStatus()">检查状态</button>
        </div>

        <div class="test-section">
            <h2>📝 操作日志</h2>
            <div id="log" class="log"></div>
            <button class="btn btn-primary" onclick="clearLog()">清空日志</button>
        </div>

        <script>
            // 模拟Vue组件的状态
            let systemState = {
                predicting: false,
                predictionTimer: null,
                currentPredictionData: null,
                showPredictionResult: false,
                predictionResult: null
            };

            // 日志功能
            function log(message, type = 'info') {
                const logDiv = document.getElementById('log');
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> ${message}`;
                logDiv.appendChild(logEntry);
                logDiv.scrollTop = logDiv.scrollHeight;
            }

            function clearLog() {
                document.getElementById('log').innerHTML = '';
            }

            // 状态检查
            function checkStatus() {
                log('🔍 检查系统状态...');

                const status = {
                    predicting: systemState.predicting,
                    predictionTimer: systemState.predictionTimer,
                    currentPredictionData: systemState.currentPredictionData,
                    showPredictionResult: systemState.showPredictionResult,
                    predictionResult: systemState.predictionResult
                };

                log(`📊 当前状态: ${JSON.stringify(status, null, 2)}`);

                // 更新显示
                document.getElementById('predictingStatus').textContent = systemState.predicting ? '预测中...' : '空闲';
                document.getElementById('timerStatus').textContent = systemState.predictionTimer ? '运行中' : '未运行';
                document.getElementById('dataStatus').textContent = systemState.currentPredictionData ? '有数据' : '无数据';

                // 检查异常状态
                if (systemState.predicting && !systemState.currentPredictionData) {
                    document.getElementById('status').className = 'status error';
                    document.getElementById('status').textContent = '⚠️ 检测到异常状态：预测中但无数据';
                    log('⚠️ 检测到异常状态：预测中但无数据', 'error');
                } else if (systemState.predicting) {
                    document.getElementById('status').className = 'status warning';
                    document.getElementById('status').textContent = '🔄 系统正在预测中...';
                    log('🔄 系统正在预测中...', 'warning');
                } else {
                    document.getElementById('status').className = 'status success';
                    document.getElementById('status').textContent = '✅ 系统状态正常';
                    log('✅ 系统状态正常', 'success');
                }
            }

            // 测试预测功能
            function testPrediction() {
                log('🚀 开始测试预测功能...');

                if (systemState.predicting) {
                    log('⚠️ 系统正在预测中，无法启动新预测', 'warning');
                    return;
                }

                // 模拟预测过程
                systemState.predicting = true;
                log('📈 设置预测状态为: true');

                // 模拟预测数据
                systemState.currentPredictionData = {
                    symbol: 'BTCUSDT',
                    startTime: Date.now(),
                    predictions: {}
                };
                log('📊 创建预测数据');

                // 模拟定时器
                systemState.predictionTimer = setTimeout(() => {
                    log('⏰ 预测定时器到期，模拟预测完成');
                    systemState.predicting = false;
                    systemState.currentPredictionData = null;
                    systemState.predictionTimer = null;
                    log('✅ 预测完成，状态已重置');
                    checkStatus();
                }, 5000); // 5秒后完成

                log('⏱️ 启动预测定时器 (5秒)');
                checkStatus();
            }

            // 强制重置状态
            function forceReset() {
                log('🔄 执行强制重置...');

                // 清理定时器
                if (systemState.predictionTimer) {
                    clearTimeout(systemState.predictionTimer);
                    systemState.predictionTimer = null;
                    log('🧹 清理预测定时器');
                }

                // 重置所有状态
                systemState.predicting = false;
                systemState.currentPredictionData = null;
                systemState.showPredictionResult = false;
                systemState.predictionResult = null;

                log('✅ 所有状态已重置');
                checkStatus();
            }

            // 页面加载时检查状态
            window.onload = function () {
                log('🚀 页面加载完成，开始系统检测...');
                checkStatus();
            };

            // 定期检查状态
            setInterval(checkStatus, 10000); // 每10秒检查一次
        </script>
    </body>

</html>
