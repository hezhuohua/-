<!DOCTYPE html>
<html lang="zh-CN">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ç¨³å®šWebSocketè¿æ¥æµ‹è¯•</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Arial', sans-serif;
                background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
                color: #fff;
                min-height: 100vh;
                padding: 20px;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
            }

            .header {
                text-align: center;
                margin-bottom: 30px;
            }

            .header h1 {
                color: #00d4ff;
                font-size: 2.5rem;
                margin-bottom: 10px;
            }

            .status-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }

            .status-card {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(0, 212, 255, 0.3);
                border-radius: 10px;
                padding: 20px;
                backdrop-filter: blur(10px);
            }

            .status-card h3 {
                color: #00d4ff;
                margin-bottom: 15px;
                font-size: 1.2rem;
            }

            .status-indicator {
                display: inline-block;
                width: 12px;
                height: 12px;
                border-radius: 50%;
                margin-right: 8px;
            }

            .status-indicator.connected {
                background: #00ff88;
                box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
            }

            .status-indicator.disconnected {
                background: #ff4757;
                box-shadow: 0 0 10px rgba(255, 71, 87, 0.5);
            }

            .status-indicator.connecting {
                background: #ffa502;
                box-shadow: 0 0 10px rgba(255, 165, 2, 0.5);
                animation: pulse 1.5s infinite;
            }

            @keyframes pulse {
                0% {
                    opacity: 1;
                }

                50% {
                    opacity: 0.5;
                }

                100% {
                    opacity: 1;
                }
            }

            .data-table {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(0, 212, 255, 0.3);
                border-radius: 10px;
                padding: 20px;
                backdrop-filter: blur(10px);
                margin-bottom: 20px;
            }

            .data-table h3 {
                color: #00d4ff;
                margin-bottom: 15px;
            }

            table {
                width: 100%;
                border-collapse: collapse;
            }

            th,
            td {
                padding: 12px;
                text-align: left;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }

            th {
                background: rgba(0, 212, 255, 0.2);
                color: #00d4ff;
                font-weight: bold;
            }

            .price-up {
                color: #00ff88;
                animation: priceUp 0.5s ease;
            }

            .price-down {
                color: #ff4757;
                animation: priceDown 0.5s ease;
            }

            @keyframes priceUp {
                0% {
                    background: rgba(0, 255, 136, 0.3);
                }

                100% {
                    background: transparent;
                }
            }

            @keyframes priceDown {
                0% {
                    background: rgba(255, 71, 87, 0.3);
                }

                100% {
                    background: transparent;
                }
            }

            .controls {
                display: flex;
                gap: 15px;
                margin-bottom: 20px;
                flex-wrap: wrap;
            }

            .btn {
                padding: 12px 24px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-size: 1rem;
                font-weight: bold;
                transition: all 0.3s ease;
            }

            .btn-primary {
                background: linear-gradient(45deg, #00d4ff, #0099cc);
                color: white;
            }

            .btn-primary:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(0, 212, 255, 0.4);
            }

            .btn-secondary {
                background: linear-gradient(45deg, #ffa502, #ff6b35);
                color: white;
            }

            .btn-secondary:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(255, 165, 2, 0.4);
            }

            .btn-danger {
                background: linear-gradient(45deg, #ff4757, #ff3742);
                color: white;
            }

            .btn-danger:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(255, 71, 87, 0.4);
            }

            .log-container {
                background: rgba(0, 0, 0, 0.8);
                border: 1px solid rgba(0, 212, 255, 0.3);
                border-radius: 10px;
                padding: 20px;
                height: 300px;
                overflow-y: auto;
                font-family: 'Courier New', monospace;
                font-size: 0.9rem;
            }

            .log-entry {
                margin-bottom: 5px;
                padding: 5px;
                border-radius: 4px;
            }

            .log-info {
                color: #00d4ff;
            }

            .log-success {
                color: #00ff88;
            }

            .log-warning {
                color: #ffa502;
            }

            .log-error {
                color: #ff4757;
            }

            .stats {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
                margin-bottom: 20px;
            }

            .stat-item {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(0, 212, 255, 0.3);
                border-radius: 8px;
                padding: 15px;
                text-align: center;
            }

            .stat-value {
                font-size: 2rem;
                font-weight: bold;
                color: #00d4ff;
            }

            .stat-label {
                color: #ccc;
                font-size: 0.9rem;
                margin-top: 5px;
            }

            .connection-info {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(0, 212, 255, 0.3);
                border-radius: 10px;
                padding: 20px;
                margin-bottom: 20px;
            }

            .connection-info h3 {
                color: #00d4ff;
                margin-bottom: 15px;
            }

            .info-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
            }

            .info-item {
                padding: 10px;
                background: rgba(0, 0, 0, 0.3);
                border-radius: 5px;
            }

            .info-label {
                color: #ccc;
                font-size: 0.8rem;
                margin-bottom: 5px;
            }

            .info-value {
                color: #fff;
                font-weight: bold;
            }
        </style>
    </head>

    <body>
        <div class="container">
            <div class="header">
                <h1>ğŸ”Œ ç¨³å®šWebSocketè¿æ¥æµ‹è¯•</h1>
                <p>ä½¿ç”¨ä¼˜åŒ–çš„è¿æ¥ç­–ç•¥ï¼Œæå‡è¿æ¥ç¨³å®šæ€§</p>
            </div>

            <div class="controls">
                <button class="btn btn-primary" onclick="connectWebSocket()">è¿æ¥WebSocket</button>
                <button class="btn btn-secondary" onclick="testRESTAPI()">æµ‹è¯•REST API</button>
                <button class="btn btn-danger" onclick="disconnectWebSocket()">æ–­å¼€è¿æ¥</button>
                <button class="btn btn-secondary" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
                <button class="btn btn-secondary" onclick="forceReconnect()">å¼ºåˆ¶é‡è¿</button>
            </div>

            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="connectionCount">0</div>
                    <div class="stat-label">è¿æ¥æ¬¡æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="disconnectCount">0</div>
                    <div class="stat-label">æ–­å¼€æ¬¡æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="reconnectCount">0</div>
                    <div class="stat-label">é‡è¿æ¬¡æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="dataUpdateCount">0</div>
                    <div class="stat-label">æ•°æ®æ›´æ–°æ¬¡æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="uptime">0s</div>
                    <div class="stat-label">è¿è¡Œæ—¶é—´</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="successRate">0%</div>
                    <div class="stat-label">æˆåŠŸç‡</div>
                </div>
            </div>

            <div class="connection-info">
                <h3>è¿æ¥é…ç½®ä¿¡æ¯</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">WebSocket URL</div>
                        <div class="info-value">wss://stream.binance.com:9443/stream</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">è®¢é˜…æ•°æ®æµ</div>
                        <div class="info-value">5ä¸ªæ ¸å¿ƒäº¤æ˜“å¯¹</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">è¿æ¥è¶…æ—¶</div>
                        <div class="info-value">20ç§’</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">é‡è¿ç­–ç•¥</div>
                        <div class="info-value">æŒ‡æ•°é€€é¿</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">å¥åº·æ£€æŸ¥</div>
                        <div class="info-value">30ç§’é—´éš”</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">æœ€å¤§é‡è¿æ¬¡æ•°</div>
                        <div class="info-value">5æ¬¡</div>
                    </div>
                </div>
            </div>

            <div class="status-grid">
                <div class="status-card">
                    <h3>WebSocketè¿æ¥çŠ¶æ€</h3>
                    <div>
                        <span class="status-indicator" id="wsStatusIndicator"></span>
                        <span id="wsStatusText">æœªè¿æ¥</span>
                    </div>
                    <div style="margin-top: 10px;">
                        <strong>è¿æ¥æ—¶é—´:</strong> <span id="wsConnectTime">-</span>
                    </div>
                    <div>
                        <strong>æœ€åæ›´æ–°:</strong> <span id="wsLastUpdate">-</span>
                    </div>
                    <div>
                        <strong>è¿æ¥æ—¶é•¿:</strong> <span id="wsDuration">-</span>
                    </div>
                </div>

                <div class="status-card">
                    <h3>REST APIçŠ¶æ€</h3>
                    <div>
                        <span class="status-indicator" id="restStatusIndicator"></span>
                        <span id="restStatusText">æœªæµ‹è¯•</span>
                    </div>
                    <div style="margin-top: 10px;">
                        <strong>å“åº”æ—¶é—´:</strong> <span id="restResponseTime">-</span>
                    </div>
                    <div>
                        <strong>æœ€åæµ‹è¯•:</strong> <span id="restLastTest">-</span>
                    </div>
                </div>

                <div class="status-card">
                    <h3>è¿æ¥è´¨é‡</h3>
                    <div>
                        <strong>å»¶è¿Ÿ:</strong> <span id="dataLatency">-</span>
                    </div>
                    <div>
                        <strong>æ•°æ®å®Œæ•´æ€§:</strong> <span id="dataIntegrity">-</span>
                    </div>
                    <div>
                        <strong>é”™è¯¯ç‡:</strong> <span id="errorRate">-</span>
                    </div>
                </div>
            </div>

            <div class="data-table">
                <h3>å®æ—¶ä»·æ ¼æ•°æ®</h3>
                <table>
                    <thead>
                        <tr>
                            <th>äº¤æ˜“å¯¹</th>
                            <th>å½“å‰ä»·æ ¼</th>
                            <th>24hæ¶¨è·Œ</th>
                            <th>æœ€åæ›´æ–°</th>
                            <th>æ•°æ®æº</th>
                            <th>æ›´æ–°é¢‘ç‡</th>
                        </tr>
                    </thead>
                    <tbody id="priceTableBody">
                        <tr>
                            <td>BTC/USDT</td>
                            <td id="btcPrice">-</td>
                            <td id="btcChange">-</td>
                            <td id="btcUpdate">-</td>
                            <td id="btcSource">-</td>
                            <td id="btcFrequency">-</td>
                        </tr>
                        <tr>
                            <td>ETH/USDT</td>
                            <td id="ethPrice">-</td>
                            <td id="ethChange">-</td>
                            <td id="ethUpdate">-</td>
                            <td id="ethSource">-</td>
                            <td id="ethFrequency">-</td>
                        </tr>
                        <tr>
                            <td>BNB/USDT</td>
                            <td id="bnbPrice">-</td>
                            <td id="bnbChange">-</td>
                            <td id="bnbUpdate">-</td>
                            <td id="bnbSource">-</td>
                            <td id="bnbFrequency">-</td>
                        </tr>
                        <tr>
                            <td>SOL/USDT</td>
                            <td id="solPrice">-</td>
                            <td id="solChange">-</td>
                            <td id="solUpdate">-</td>
                            <td id="solSource">-</td>
                            <td id="solFrequency">-</td>
                        </tr>
                        <tr>
                            <td>XRP/USDT</td>
                            <td id="xrpPrice">-</td>
                            <td id="xrpChange">-</td>
                            <td id="xrpUpdate">-</td>
                            <td id="xrpSource">-</td>
                            <td id="xrpFrequency">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="data-table">
                <h3>è¿æ¥æ—¥å¿—</h3>
                <div class="log-container" id="logContainer">
                    <div class="log-entry log-info">ç¨³å®šWebSocketè¿æ¥æµ‹è¯•ç³»ç»Ÿå·²å¯åŠ¨</div>
                </div>
            </div>
        </div>

        <script>
            // å…¨å±€å˜é‡
            let ws = null;
            let isConnected = false;
            let connectionStartTime = 0;
            let lastUpdateTime = 0;
            let lastDataUpdateTime = 0;
            let reconnectAttempts = 0;
            let maxReconnectAttempts = 5;
            let reconnectInterval = 5000;
            let reconnectTimeout = null;
            let healthCheckInterval = null;
            let dataUpdateInterval = null;
            let uptimeInterval = null;

            // ç»Ÿè®¡æ•°æ®
            let stats = {
                connectionCount: 0,
                disconnectCount: 0,
                reconnectCount: 0,
                dataUpdateCount: 0,
                successCount: 0,
                errorCount: 0,
                totalRequests: 0
            };

            // ä»·æ ¼æ•°æ®ç¼“å­˜
            let priceData = {
                btc: { price: 0, change: 0, source: '', updateTime: 0, frequency: 0 },
                eth: { price: 0, change: 0, source: '', updateTime: 0, frequency: 0 },
                bnb: { price: 0, change: 0, source: '', updateTime: 0, frequency: 0 },
                sol: { price: 0, change: 0, source: '', updateTime: 0, frequency: 0 },
                xrp: { price: 0, change: 0, source: '', updateTime: 0, frequency: 0 }
            };

            // åˆå§‹åŒ–
            document.addEventListener('DOMContentLoaded', function () {
                updateStats();
                startUptimeCounter();
                log('info', 'ç¨³å®šWebSocketè¿æ¥æµ‹è¯•ç³»ç»Ÿå·²å¯åŠ¨');
            });

            // è¿æ¥WebSocket - ä½¿ç”¨ä¼˜åŒ–çš„è¿æ¥ç­–ç•¥
            function connectWebSocket() {
                if (isConnected) {
                    log('warning', 'WebSocketå·²è¿æ¥ï¼Œæ— éœ€é‡å¤è¿æ¥');
                    return;
                }

                cleanupWebSocket();
                log('info', 'æ­£åœ¨è¿æ¥WebSocket...');
                updateWSStatus('connecting', 'è¿æ¥ä¸­...');

                try {
                    // åªè®¢é˜…æ ¸å¿ƒæ•°æ®æµï¼Œå‡å°‘è¿æ¥å‹åŠ›
                    const streams = [
                        'btcusdt@ticker',
                        'ethusdt@ticker',
                        'bnbusdt@ticker',
                        'solusdt@ticker',
                        'xrpusdt@ticker'
                    ].join('/');

                    const wsUrl = `wss://stream.binance.com:9443/stream?streams=${streams}`;

                    // å¢åŠ è¿æ¥è¶…æ—¶æ—¶é—´
                    const connectionTimeout = setTimeout(() => {
                        if (ws && ws.readyState === WebSocket.CONNECTING) {
                            log('error', 'WebSocketè¿æ¥è¶…æ—¶');
                            ws.close();
                        }
                    }, 20000); // 20ç§’è¶…æ—¶

                    ws = new WebSocket(wsUrl);
                    connectionStartTime = Date.now();

                    ws.onopen = function () {
                        clearTimeout(connectionTimeout);
                        isConnected = true;
                        reconnectAttempts = 0;
                        stats.connectionCount++;

                        log('success', 'WebSocketè¿æ¥æˆåŠŸ');
                        updateWSStatus('connected', 'å·²è¿æ¥');
                        updateStats();

                        startHealthCheck();
                        startDataUpdateInterval();
                    };

                    ws.onmessage = function (event) {
                        try {
                            const message = JSON.parse(event.data);
                            if (message.data) {
                                processPriceData(message.data, 'WebSocket');
                                lastDataUpdateTime = Date.now();
                            }
                        } catch (error) {
                            log('error', 'å¤„ç†WebSocketæ¶ˆæ¯å¤±è´¥: ' + error.message);
                            stats.errorCount++;
                            updateStats();
                        }
                    };

                    ws.onclose = function (event) {
                        clearTimeout(connectionTimeout);
                        isConnected = false;
                        stats.disconnectCount++;

                        log('warning', `WebSocketè¿æ¥å…³é—­ (ä»£ç : ${event.code})`);
                        updateWSStatus('disconnected', 'å·²æ–­å¼€');
                        updateStats();

                        cleanupHealthCheck();
                        cleanupDataUpdateInterval();

                        // æ›´ä¿å®ˆçš„é‡è¿ç­–ç•¥
                        if (event.code !== 1000 && event.code !== 1001) {
                            if (reconnectAttempts < maxReconnectAttempts) {
                                reconnectAttempts++;
                                stats.reconnectCount++;
                                // ä½¿ç”¨æ›´ä¿å®ˆçš„æŒ‡æ•°é€€é¿
                                const delay = Math.min(reconnectInterval * Math.pow(2, reconnectAttempts - 1), 120000);

                                log('info', `${Math.round(delay / 1000)}ç§’åè¿›è¡Œç¬¬${reconnectAttempts}æ¬¡é‡è¿...`);
                                updateStats();

                                reconnectTimeout = setTimeout(() => {
                                    connectWebSocket();
                                }, delay);
                            } else {
                                log('error', 'WebSocketé‡è¿å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•°');
                                showNotification('WebSocketé‡è¿å¤±è´¥ï¼Œåˆ‡æ¢åˆ°å¤‡ç”¨æ•°æ®æº', 'warning');
                                startBackupDataSource();
                            }
                        }
                    };

                    ws.onerror = function (error) {
                        log('error', 'WebSocketè¿æ¥é”™è¯¯: ' + error.message);
                        stats.errorCount++;
                        updateStats();
                    };

                } catch (error) {
                    log('error', 'åˆ›å»ºWebSocketè¿æ¥å¤±è´¥: ' + error.message);
                    stats.errorCount++;
                    updateStats();
                }
            }

            // å¯åŠ¨è¿æ¥å¥åº·æ£€æŸ¥
            function startHealthCheck() {
                if (healthCheckInterval) {
                    clearInterval(healthCheckInterval);
                }

                healthCheckInterval = setInterval(() => {
                    if (isConnected && ws && ws.readyState === WebSocket.OPEN) {
                        // æ£€æŸ¥è¿æ¥æ—¶é—´ï¼Œå¦‚æœè¶…è¿‡30åˆ†é’Ÿåˆ™é‡æ–°è¿æ¥
                        const connectionDuration = Date.now() - connectionStartTime;
                        if (connectionDuration > 1800000) { // 30åˆ†é’Ÿ
                            log('info', 'è¿æ¥æ—¶é—´è¿‡é•¿ï¼Œé‡æ–°è¿æ¥ä»¥ä¿æŒç¨³å®šæ€§');
                            ws.close();
                        }

                        // æ£€æŸ¥æœ€åæ•°æ®æ›´æ–°æ—¶é—´
                        if (lastDataUpdateTime && (Date.now() - lastDataUpdateTime) > 60000) {
                            log('warning', 'æ•°æ®æ›´æ–°è¶…æ—¶ï¼Œé‡æ–°è¿æ¥');
                            ws.close();
                        }

                        // æ›´æ–°è¿æ¥æ—¶é•¿æ˜¾ç¤º
                        updateConnectionDuration();
                    }
                }, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
            }

            // æ¸…ç†å¥åº·æ£€æŸ¥
            function cleanupHealthCheck() {
                if (healthCheckInterval) {
                    clearInterval(healthCheckInterval);
                    healthCheckInterval = null;
                }
            }

            // å¯åŠ¨æ•°æ®æ›´æ–°å®šæ—¶å™¨
            function startDataUpdateInterval() {
                if (dataUpdateInterval) {
                    clearInterval(dataUpdateInterval);
                }

                dataUpdateInterval = setInterval(() => {
                    if (isConnected) {
                        lastUpdateTime = Date.now();
                        document.getElementById('wsLastUpdate').textContent = new Date().toLocaleTimeString();
                    }
                }, 10000);
            }

            // æ¸…ç†æ•°æ®æ›´æ–°å®šæ—¶å™¨
            function cleanupDataUpdateInterval() {
                if (dataUpdateInterval) {
                    clearInterval(dataUpdateInterval);
                    dataUpdateInterval = null;
                }
            }

            // æµ‹è¯•REST API
            async function testRESTAPI() {
                log('info', 'æ­£åœ¨æµ‹è¯•REST API...');
                updateRESTStatus('connecting', 'æµ‹è¯•ä¸­...');

                const startTime = Date.now();

                try {
                    const response = await fetch('https://api.binance.com/api/v3/ticker/24hr?symbols=["BTCUSDT","ETHUSDT","BNBUSDT","SOLUSDT","XRPUSDT"]');
                    const data = await response.json();

                    const responseTime = Date.now() - startTime;

                    if (response.ok && data.length > 0) {
                        log('success', `REST APIæµ‹è¯•æˆåŠŸï¼Œå“åº”æ—¶é—´: ${responseTime}ms`);
                        updateRESTStatus('connected', 'æ­£å¸¸');

                        data.forEach(item => {
                            processPriceData(item, 'REST API');
                        });

                        document.getElementById('restResponseTime').textContent = responseTime + 'ms';
                        document.getElementById('restLastTest').textContent = new Date().toLocaleTimeString();

                        stats.successCount++;
                        updateStats();
                    } else {
                        throw new Error('APIå“åº”å¼‚å¸¸');
                    }
                } catch (error) {
                    log('error', 'REST APIæµ‹è¯•å¤±è´¥: ' + error.message);
                    updateRESTStatus('disconnected', 'å¤±è´¥');
                    stats.errorCount++;
                    updateStats();
                }
            }

            // å¤„ç†ä»·æ ¼æ•°æ®
            function processPriceData(data, source) {
                const symbol = data.s ? data.s.toLowerCase() : data.symbol.toLowerCase();
                const price = data.c ? parseFloat(data.c) : parseFloat(data.lastPrice);
                const change = data.P ? parseFloat(data.P) : parseFloat(data.priceChangePercent);

                const symbolMap = {
                    'btcusdt': 'btc',
                    'ethusdt': 'eth',
                    'bnbusdt': 'bnb',
                    'solusdt': 'sol',
                    'xrpusdt': 'xrp'
                };

                const coin = symbolMap[symbol];
                if (coin) {
                    const oldPrice = priceData[coin].price;
                    const oldUpdateTime = priceData[coin].updateTime;

                    priceData[coin] = {
                        price: price,
                        change: change,
                        source: source,
                        updateTime: Date.now(),
                        frequency: oldUpdateTime ? Math.round((Date.now() - oldUpdateTime) / 1000) : 0
                    };

                    updatePriceDisplay(coin, oldPrice);
                    stats.dataUpdateCount++;
                    stats.successCount++;
                    updateStats();
                }
            }

            // æ›´æ–°ä»·æ ¼æ˜¾ç¤º
            function updatePriceDisplay(coin, oldPrice) {
                const priceElement = document.getElementById(coin + 'Price');
                const changeElement = document.getElementById(coin + 'Change');
                const updateElement = document.getElementById(coin + 'Update');
                const sourceElement = document.getElementById(coin + 'Source');
                const frequencyElement = document.getElementById(coin + 'Frequency');

                if (priceElement && changeElement && updateElement && sourceElement && frequencyElement) {
                    const data = priceData[coin];

                    // ä»·æ ¼åŠ¨ç”»
                    if (data.price > oldPrice) {
                        priceElement.classList.add('price-up');
                        setTimeout(() => priceElement.classList.remove('price-up'), 500);
                    } else if (data.price < oldPrice) {
                        priceElement.classList.add('price-down');
                        setTimeout(() => priceElement.classList.remove('price-down'), 500);
                    }

                    priceElement.textContent = '$' + data.price.toLocaleString('en-US', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });

                    changeElement.textContent = (data.change >= 0 ? '+' : '') + data.change.toFixed(2) + '%';
                    changeElement.style.color = data.change >= 0 ? '#00ff88' : '#ff4757';

                    updateElement.textContent = new Date(data.updateTime).toLocaleTimeString();
                    sourceElement.textContent = data.source;
                    frequencyElement.textContent = data.frequency + 's';
                }
            }

            // æ–­å¼€WebSocketè¿æ¥
            function disconnectWebSocket() {
                if (ws) {
                    ws.close(1000, 'ç”¨æˆ·ä¸»åŠ¨æ–­å¼€');
                    log('info', 'ç”¨æˆ·ä¸»åŠ¨æ–­å¼€WebSocketè¿æ¥');
                }
            }

            // å¼ºåˆ¶é‡è¿
            function forceReconnect() {
                log('info', 'å¼ºåˆ¶é‡è¿WebSocket');
                if (ws) {
                    ws.close();
                }
                reconnectAttempts = 0;
                setTimeout(() => {
                    connectWebSocket();
                }, 1000);
            }

            // æ¸…ç†WebSocketè¿æ¥
            function cleanupWebSocket() {
                if (ws) {
                    ws.close();
                    ws = null;
                }
                cleanupHealthCheck();
                cleanupDataUpdateInterval();
                if (reconnectTimeout) {
                    clearTimeout(reconnectTimeout);
                    reconnectTimeout = null;
                }
            }

            // æ›´æ–°WebSocketçŠ¶æ€
            function updateWSStatus(status, text) {
                const indicator = document.getElementById('wsStatusIndicator');
                const statusText = document.getElementById('wsStatusText');
                const connectTime = document.getElementById('wsConnectTime');

                indicator.className = 'status-indicator ' + status;
                statusText.textContent = text;

                if (status === 'connected') {
                    connectTime.textContent = new Date(connectionStartTime).toLocaleTimeString();
                }
            }

            // æ›´æ–°è¿æ¥æ—¶é•¿
            function updateConnectionDuration() {
                if (isConnected && connectionStartTime) {
                    const duration = Math.floor((Date.now() - connectionStartTime) / 1000);
                    document.getElementById('wsDuration').textContent = duration + 's';
                }
            }

            // æ›´æ–°REST APIçŠ¶æ€
            function updateRESTStatus(status, text) {
                const indicator = document.getElementById('restStatusIndicator');
                const statusText = document.getElementById('restStatusText');

                indicator.className = 'status-indicator ' + status;
                statusText.textContent = text;
            }

            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            function updateStats() {
                document.getElementById('connectionCount').textContent = stats.connectionCount;
                document.getElementById('disconnectCount').textContent = stats.disconnectCount;
                document.getElementById('reconnectCount').textContent = stats.reconnectCount;
                document.getElementById('dataUpdateCount').textContent = stats.dataUpdateCount;

                // è®¡ç®—æˆåŠŸç‡
                const totalRequests = stats.successCount + stats.errorCount;
                const successRate = totalRequests > 0 ? ((stats.successCount / totalRequests) * 100).toFixed(1) : '0.0';

                document.getElementById('successRate').textContent = successRate + '%';
            }

            // å¯åŠ¨è¿è¡Œæ—¶é—´è®¡æ•°å™¨
            function startUptimeCounter() {
                const startTime = Date.now();
                uptimeInterval = setInterval(() => {
                    const uptime = Math.floor((Date.now() - startTime) / 1000);
                    document.getElementById('uptime').textContent = uptime + 's';
                }, 1000);
            }

            // æ·»åŠ æ—¥å¿—
            function log(level, message) {
                const logContainer = document.getElementById('logContainer');
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry log-${level}`;
                logEntry.textContent = `[${timestamp}] ${message}`;

                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;

                // é™åˆ¶æ—¥å¿—æ¡æ•°
                while (logContainer.children.length > 100) {
                    logContainer.removeChild(logContainer.firstChild);
                }
            }

            // æ¸…ç©ºæ—¥å¿—
            function clearLog() {
                document.getElementById('logContainer').innerHTML = '';
                log('info', 'æ—¥å¿—å·²æ¸…ç©º');
            }

            // æ˜¾ç¤ºé€šçŸ¥
            function showNotification(message, type) {
                log(type, message);
            }

            // å¯åŠ¨å¤‡ç”¨æ•°æ®æº
            function startBackupDataSource() {
                log('info', 'å¯åŠ¨å¤‡ç”¨æ•°æ®æº');
                fetchPriceFromAPI();
                setInterval(fetchPriceFromAPI, 30000);
            }

            // å¤‡ç”¨æ•°æ®æº
            async function fetchPriceFromAPI() {
                try {
                    const response = await fetch('https://api.binance.com/api/v3/ticker/24hr?symbols=["BTCUSDT","ETHUSDT","BNBUSDT","SOLUSDT","XRPUSDT"]');
                    const data = await response.json();

                    data.forEach(item => {
                        processPriceData(item, 'REST API');
                    });

                    log('info', 'REST APIæ•°æ®æ›´æ–°æˆåŠŸ');
                } catch (error) {
                    log('error', 'REST APIè·å–æ•°æ®å¤±è´¥: ' + error.message);
                }
            }

            // é¡µé¢å¸è½½æ—¶æ¸…ç†
            window.addEventListener('beforeunload', function () {
                cleanupWebSocket();
                if (uptimeInterval) {
                    clearInterval(uptimeInterval);
                }
            });
        </script>
    </body>

</html>
