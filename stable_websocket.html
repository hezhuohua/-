<!DOCTYPE html>
<html lang="zh-CN">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Á®≥ÂÆöWebSocketËøûÊé•ÊµãËØï</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Arial', sans-serif;
                background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
                color: #fff;
                min-height: 100vh;
                padding: 20px;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
            }

            .header {
                text-align: center;
                margin-bottom: 30px;
            }

            .header h1 {
                color: #00d4ff;
                font-size: 2.5rem;
                margin-bottom: 10px;
            }

            .status-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }

            .status-card {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(0, 212, 255, 0.3);
                border-radius: 10px;
                padding: 20px;
                backdrop-filter: blur(10px);
            }

            .status-card h3 {
                color: #00d4ff;
                margin-bottom: 15px;
                font-size: 1.2rem;
            }

            .status-indicator {
                display: inline-block;
                width: 12px;
                height: 12px;
                border-radius: 50%;
                margin-right: 8px;
            }

            .status-indicator.connected {
                background: #00ff88;
                box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
            }

            .status-indicator.disconnected {
                background: #ff4757;
                box-shadow: 0 0 10px rgba(255, 71, 87, 0.5);
            }

            .status-indicator.connecting {
                background: #ffa502;
                box-shadow: 0 0 10px rgba(255, 165, 2, 0.5);
                animation: pulse 1.5s infinite;
            }

            @keyframes pulse {
                0% {
                    opacity: 1;
                }

                50% {
                    opacity: 0.5;
                }

                100% {
                    opacity: 1;
                }
            }

            .data-table {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(0, 212, 255, 0.3);
                border-radius: 10px;
                padding: 20px;
                backdrop-filter: blur(10px);
                margin-bottom: 20px;
            }

            .data-table h3 {
                color: #00d4ff;
                margin-bottom: 15px;
            }

            table {
                width: 100%;
                border-collapse: collapse;
            }

            th,
            td {
                padding: 12px;
                text-align: left;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }

            th {
                background: rgba(0, 212, 255, 0.2);
                color: #00d4ff;
                font-weight: bold;
            }

            .price-up {
                color: #00ff88;
                animation: priceUp 0.5s ease;
            }

            .price-down {
                color: #ff4757;
                animation: priceDown 0.5s ease;
            }

            @keyframes priceUp {
                0% {
                    background: rgba(0, 255, 136, 0.3);
                }

                100% {
                    background: transparent;
                }
            }

            @keyframes priceDown {
                0% {
                    background: rgba(255, 71, 87, 0.3);
                }

                100% {
                    background: transparent;
                }
            }

            .controls {
                display: flex;
                gap: 15px;
                margin-bottom: 20px;
                flex-wrap: wrap;
            }

            .btn {
                padding: 12px 24px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-size: 1rem;
                font-weight: bold;
                transition: all 0.3s ease;
            }

            .btn-primary {
                background: linear-gradient(45deg, #00d4ff, #0099cc);
                color: white;
            }

            .btn-primary:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(0, 212, 255, 0.4);
            }

            .btn-secondary {
                background: linear-gradient(45deg, #ffa502, #ff6b35);
                color: white;
            }

            .btn-secondary:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(255, 165, 2, 0.4);
            }

            .btn-danger {
                background: linear-gradient(45deg, #ff4757, #ff3742);
                color: white;
            }

            .btn-danger:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(255, 71, 87, 0.4);
            }

            .log-container {
                background: rgba(0, 0, 0, 0.8);
                border: 1px solid rgba(0, 212, 255, 0.3);
                border-radius: 10px;
                padding: 20px;
                height: 300px;
                overflow-y: auto;
                font-family: 'Courier New', monospace;
                font-size: 0.9rem;
            }

            .log-entry {
                margin-bottom: 5px;
                padding: 5px;
                border-radius: 4px;
            }

            .log-info {
                color: #00d4ff;
            }

            .log-success {
                color: #00ff88;
            }

            .log-warning {
                color: #ffa502;
            }

            .log-error {
                color: #ff4757;
            }

            .stats {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
                margin-bottom: 20px;
            }

            .stat-item {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(0, 212, 255, 0.3);
                border-radius: 8px;
                padding: 15px;
                text-align: center;
            }

            .stat-value {
                font-size: 2rem;
                font-weight: bold;
                color: #00d4ff;
            }

            .stat-label {
                color: #ccc;
                font-size: 0.9rem;
                margin-top: 5px;
            }

            .connection-info {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(0, 212, 255, 0.3);
                border-radius: 10px;
                padding: 20px;
                margin-bottom: 20px;
            }

            .connection-info h3 {
                color: #00d4ff;
                margin-bottom: 15px;
            }

            .info-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
            }

            .info-item {
                padding: 10px;
                background: rgba(0, 0, 0, 0.3);
                border-radius: 5px;
            }

            .info-label {
                color: #ccc;
                font-size: 0.8rem;
                margin-bottom: 5px;
            }

            .info-value {
                color: #fff;
                font-weight: bold;
            }
        </style>
    </head>

    <body>
        <div class="container">
            <div class="header">
                <h1>üîå Á®≥ÂÆöWebSocketËøûÊé•ÊµãËØï</h1>
                <p>‰ΩøÁî®‰ºòÂåñÁöÑËøûÊé•Á≠ñÁï•ÔºåÊèêÂçáËøûÊé•Á®≥ÂÆöÊÄß</p>
            </div>

            <div class="controls">
                <button class="btn btn-primary" onclick="connectWebSocket()">ËøûÊé•WebSocket</button>
                <button class="btn btn-secondary" onclick="testRESTAPI()">ÊµãËØïREST API</button>
                <button class="btn btn-danger" onclick="disconnectWebSocket()">Êñ≠ÂºÄËøûÊé•</button>
                <button class="btn btn-secondary" onclick="clearLog()">Ê∏ÖÁ©∫Êó•Âøó</button>
                <button class="btn btn-secondary" onclick="forceReconnect()">Âº∫Âà∂ÈáçËøû</button>
            </div>

            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="connectionCount">0</div>
                    <div class="stat-label">ËøûÊé•Ê¨°Êï∞</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="disconnectCount">0</div>
                    <div class="stat-label">Êñ≠ÂºÄÊ¨°Êï∞</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="reconnectCount">0</div>
                    <div class="stat-label">ÈáçËøûÊ¨°Êï∞</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="dataUpdateCount">0</div>
                    <div class="stat-label">Êï∞ÊçÆÊõ¥Êñ∞Ê¨°Êï∞</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="uptime">0s</div>
                    <div class="stat-label">ËøêË°åÊó∂Èó¥</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="successRate">0%</div>
                    <div class="stat-label">ÊàêÂäüÁéá</div>
                </div>
            </div>

            <div class="connection-info">
                <h3>ËøûÊé•ÈÖçÁΩÆ‰ø°ÊÅØ</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">WebSocket URL</div>
                        <div class="info-value">wss://stream.binance.com:9443/stream</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ËÆ¢ÈòÖÊï∞ÊçÆÊµÅ</div>
                        <div class="info-value">5‰∏™Ê†∏ÂøÉ‰∫§ÊòìÂØπ</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ËøûÊé•Ë∂ÖÊó∂</div>
                        <div class="info-value">20Áßí</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ÈáçËøûÁ≠ñÁï•</div>
                        <div class="info-value">ÊåáÊï∞ÈÄÄÈÅø</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ÂÅ•Â∫∑Ê£ÄÊü•</div>
                        <div class="info-value">30ÁßíÈó¥Èöî</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ÊúÄÂ§ßÈáçËøûÊ¨°Êï∞</div>
                        <div class="info-value">5Ê¨°</div>
                    </div>
                </div>
            </div>

            <div class="status-grid">
                <div class="status-card">
                    <h3>WebSocketËøûÊé•Áä∂ÊÄÅ</h3>
                    <div>
                        <span class="status-indicator" id="wsStatusIndicator"></span>
                        <span id="wsStatusText">Êú™ËøûÊé•</span>
                    </div>
                    <div style="margin-top: 10px;">
                        <strong>ËøûÊé•Êó∂Èó¥:</strong> <span id="wsConnectTime">-</span>
                    </div>
                    <div>
                        <strong>ÊúÄÂêéÊõ¥Êñ∞:</strong> <span id="wsLastUpdate">-</span>
                    </div>
                    <div>
                        <strong>ËøûÊé•Êó∂Èïø:</strong> <span id="wsDuration">-</span>
                    </div>
                </div>

                <div class="status-card">
                    <h3>REST APIÁä∂ÊÄÅ</h3>
                    <div>
                        <span class="status-indicator" id="restStatusIndicator"></span>
                        <span id="restStatusText">Êú™ÊµãËØï</span>
                    </div>
                    <div style="margin-top: 10px;">
                        <strong>ÂìçÂ∫îÊó∂Èó¥:</strong> <span id="restResponseTime">-</span>
                    </div>
                    <div>
                        <strong>ÊúÄÂêéÊµãËØï:</strong> <span id="restLastTest">-</span>
                    </div>
                </div>

                <div class="status-card">
                    <h3>ËøûÊé•Ë¥®Èáè</h3>
                    <div>
                        <strong>Âª∂Ëøü:</strong> <span id="dataLatency">-</span>
                    </div>
                    <div>
                        <strong>Êï∞ÊçÆÂÆåÊï¥ÊÄß:</strong> <span id="dataIntegrity">-</span>
                    </div>
                    <div>
                        <strong>ÈîôËØØÁéá:</strong> <span id="errorRate">-</span>
                    </div>
                </div>
            </div>

            <div class="data-table">
                <h3>ÂÆûÊó∂‰ª∑Ê†ºÊï∞ÊçÆ</h3>
                <table>
                    <thead>
                        <tr>
                            <th>‰∫§ÊòìÂØπ</th>
                            <th>ÂΩìÂâç‰ª∑Ê†º</th>
                            <th>24hÊ∂®Ë∑å</th>
                            <th>ÊúÄÂêéÊõ¥Êñ∞</th>
                            <th>Êï∞ÊçÆÊ∫ê</th>
                            <th>Êõ¥Êñ∞È¢ëÁéá</th>
                        </tr>
                    </thead>
                    <tbody id="priceTableBody">
                        <tr>
                            <td>BTC/USDT</td>
                            <td id="btcPrice">-</td>
                            <td id="btcChange">-</td>
                            <td id="btcUpdate">-</td>
                            <td id="btcSource">-</td>
                            <td id="btcFrequency">-</td>
                        </tr>
                        <tr>
                            <td>ETH/USDT</td>
                            <td id="ethPrice">-</td>
                            <td id="ethChange">-</td>
                            <td id="ethUpdate">-</td>
                            <td id="ethSource">-</td>
                            <td id="ethFrequency">-</td>
                        </tr>
                        <tr>
                            <td>BNB/USDT</td>
                            <td id="bnbPrice">-</td>
                            <td id="bnbChange">-</td>
                            <td id="bnbUpdate">-</td>
                            <td id="bnbSource">-</td>
                            <td id="bnbFrequency">-</td>
                        </tr>
                        <tr>
                            <td>SOL/USDT</td>
                            <td id="solPrice">-</td>
                            <td id="solChange">-</td>
                            <td id="solUpdate">-</td>
                            <td id="solSource">-</td>
                            <td id="solFrequency">-</td>
                        </tr>
                        <tr>
                            <td>XRP/USDT</td>
                            <td id="xrpPrice">-</td>
                            <td id="xrpChange">-</td>
                            <td id="xrpUpdate">-</td>
                            <td id="xrpSource">-</td>
                            <td id="xrpFrequency">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="data-table">
                <h3>ËøûÊé•Êó•Âøó</h3>
                <div class="log-container" id="logContainer">
                    <div class="log-entry log-info">Á®≥ÂÆöWebSocketËøûÊé•ÊµãËØïÁ≥ªÁªüÂ∑≤ÂêØÂä®</div>
                </div>
            </div>
        </div>

        <script>
            // ÂÖ®Â±ÄÂèòÈáè
            let ws = null;
            let isConnected = false;
            let connectionStartTime = 0;
            let lastUpdateTime = 0;
            let lastDataUpdateTime = 0;
            let reconnectAttempts = 0;
            let maxReconnectAttempts = 5;
            let reconnectInterval = 5000;
            let reconnectTimeout = null;
            let healthCheckInterval = null;
            let dataUpdateInterval = null;
            let uptimeInterval = null;

            // ÁªüËÆ°Êï∞ÊçÆ
            let stats = {
                connectionCount: 0,
                disconnectCount: 0,
                reconnectCount: 0,
                dataUpdateCount: 0,
                successCount: 0,
                errorCount: 0,
                totalRequests: 0
            };

            // ‰ª∑Ê†ºÊï∞ÊçÆÁºìÂ≠ò
            let priceData = {
                btc: { price: 0, change: 0, source: '', updateTime: 0, frequency: 0 },
                eth: { price: 0, change: 0, source: '', updateTime: 0, frequency: 0 },
                bnb: { price: 0, change: 0, source: '', updateTime: 0, frequency: 0 },
                sol: { price: 0, change: 0, source: '', updateTime: 0, frequency: 0 },
                xrp: { price: 0, change: 0, source: '', updateTime: 0, frequency: 0 }
            };

            // ÂàùÂßãÂåñ
            document.addEventListener('DOMContentLoaded', function () {
                updateStats();
                startUptimeCounter();
                log('info', 'Á®≥ÂÆöWebSocketËøûÊé•ÊµãËØïÁ≥ªÁªüÂ∑≤ÂêØÂä®');
            });

            // ËøûÊé•WebSocket - ‰ΩøÁî®‰ºòÂåñÁöÑËøûÊé•Á≠ñÁï•
            function connectWebSocket() {
                if (isConnected) {
                    log('warning', 'WebSocketÂ∑≤ËøûÊé•ÔºåÊó†ÈúÄÈáçÂ§çËøûÊé•');
                    return;
                }

                cleanupWebSocket();
                log('info', 'Ê≠£Âú®ËøûÊé•WebSocket...');
                updateWSStatus('connecting', 'ËøûÊé•‰∏≠...');

                try {
                    // Âè™ËÆ¢ÈòÖÊ†∏ÂøÉÊï∞ÊçÆÊµÅÔºåÂáèÂ∞ëËøûÊé•ÂéãÂäõ
                    const streams = [
                        'btcusdt@ticker',
                        'ethusdt@ticker',
                        'bnbusdt@ticker',
                        'solusdt@ticker',
                        'xrpusdt@ticker'
                    ].join('/');

                    const wsUrl = `wss://stream.binance.com:9443/stream?streams=${streams}`;

                    // Â¢ûÂä†ËøûÊé•Ë∂ÖÊó∂Êó∂Èó¥
                    const connectionTimeout = setTimeout(() => {
                        if (ws && ws.readyState === WebSocket.CONNECTING) {
                            log('error', 'WebSocketËøûÊé•Ë∂ÖÊó∂');
                            ws.close();
                        }
                    }, 20000); // 20ÁßíË∂ÖÊó∂

                    ws = new WebSocket(wsUrl);
                    connectionStartTime = Date.now();

                    ws.onopen = function () {
                        clearTimeout(connectionTimeout);
                        isConnected = true;
                        reconnectAttempts = 0;
                        stats.connectionCount++;

                        log('success', 'WebSocketËøûÊé•ÊàêÂäü');
                        updateWSStatus('connected', 'Â∑≤ËøûÊé•');
                        updateStats();

                        startHealthCheck();
                        startDataUpdateInterval();
                    };

                    ws.onmessage = function (event) {
                        try {
                            const message = JSON.parse(event.data);
                            if (message.data) {
                                processPriceData(message.data, 'WebSocket');
                                lastDataUpdateTime = Date.now();
                            }
                        } catch (error) {
                            log('error', 'Â§ÑÁêÜWebSocketÊ∂àÊÅØÂ§±Ë¥•: ' + error.message);
                            stats.errorCount++;
                            updateStats();
                        }
                    };

                    ws.onclose = function (event) {
                        clearTimeout(connectionTimeout);
                        isConnected = false;
                        stats.disconnectCount++;

                        log('warning', `WebSocketËøûÊé•ÂÖ≥Èó≠ (‰ª£Á†Å: ${event.code})`);
                        updateWSStatus('disconnected', 'Â∑≤Êñ≠ÂºÄ');
                        updateStats();

                        cleanupHealthCheck();
                        cleanupDataUpdateInterval();

                        // Êõ¥‰øùÂÆàÁöÑÈáçËøûÁ≠ñÁï•
                        if (event.code !== 1000 && event.code !== 1001) {
                            if (reconnectAttempts < maxReconnectAttempts) {
                                reconnectAttempts++;
                                stats.reconnectCount++;
                                // ‰ΩøÁî®Êõ¥‰øùÂÆàÁöÑÊåáÊï∞ÈÄÄÈÅø
                                const delay = Math.min(reconnectInterval * Math.pow(2, reconnectAttempts - 1), 120000);

                                log('info', `${Math.round(delay / 1000)}ÁßíÂêéËøõË°åÁ¨¨${reconnectAttempts}Ê¨°ÈáçËøû...`);
                                updateStats();

                                reconnectTimeout = setTimeout(() => {
                                    connectWebSocket();
                                }, delay);
                            } else {
                                log('error', 'WebSocketÈáçËøûÂ§±Ë¥•ÔºåÂ∑≤ËææÂà∞ÊúÄÂ§ßÈáçËøûÊ¨°Êï∞');
                                showNotification('WebSocketÈáçËøûÂ§±Ë¥•ÔºåÂàáÊç¢Âà∞Â§áÁî®Êï∞ÊçÆÊ∫ê', 'warning');
                                startBackupDataSource();
                            }
                        }
                    };

                    ws.onerror = function (error) {
                        log('error', 'WebSocketËøûÊé•ÈîôËØØ: ' + error.message);
                        stats.errorCount++;
                        updateStats();
                    };

                } catch (error) {
                    log('error', 'ÂàõÂª∫WebSocketËøûÊé•Â§±Ë¥•: ' + error.message);
                    stats.errorCount++;
                    updateStats();
                }
            }

            // ÂêØÂä®ËøûÊé•ÂÅ•Â∫∑Ê£ÄÊü•
            function startHealthCheck() {
                if (healthCheckInterval) {
                    clearInterval(healthCheckInterval);
                }

                healthCheckInterval = setInterval(() => {
                    if (isConnected && ws && ws.readyState === WebSocket.OPEN) {
                        // Ê£ÄÊü•ËøûÊé•Êó∂Èó¥ÔºåÂ¶ÇÊûúË∂ÖËøá30ÂàÜÈíüÂàôÈáçÊñ∞ËøûÊé•
                        const connectionDuration = Date.now() - connectionStartTime;
                        if (connectionDuration > 1800000) { // 30ÂàÜÈíü
                            log('info', 'ËøûÊé•Êó∂Èó¥ËøáÈïøÔºåÈáçÊñ∞ËøûÊé•‰ª•‰øùÊåÅÁ®≥ÂÆöÊÄß');
                            ws.close();
                        }

                        // Ê£ÄÊü•ÊúÄÂêéÊï∞ÊçÆÊõ¥Êñ∞Êó∂Èó¥
                        if (lastDataUpdateTime && (Date.now() - lastDataUpdateTime) > 60000) {
                            log('warning', 'Êï∞ÊçÆÊõ¥Êñ∞Ë∂ÖÊó∂ÔºåÈáçÊñ∞ËøûÊé•');
                            ws.close();
                        }

                        // Êõ¥Êñ∞ËøûÊé•Êó∂ÈïøÊòæÁ§∫
                        updateConnectionDuration();
                    }
                }, 30000); // ÊØè30ÁßíÊ£ÄÊü•‰∏ÄÊ¨°
            }

            // Ê∏ÖÁêÜÂÅ•Â∫∑Ê£ÄÊü•
            function cleanupHealthCheck() {
                if (healthCheckInterval) {
                    clearInterval(healthCheckInterval);
                    healthCheckInterval = null;
                }
            }

            // ÂêØÂä®Êï∞ÊçÆÊõ¥Êñ∞ÂÆöÊó∂Âô®
            function startDataUpdateInterval() {
                if (dataUpdateInterval) {
                    clearInterval(dataUpdateInterval);
                }

                dataUpdateInterval = setInterval(() => {
                    if (isConnected) {
                        lastUpdateTime = Date.now();
                        document.getElementById('wsLastUpdate').textContent = new Date().toLocaleTimeString();
                    }
                }, 10000);
            }

            // Ê∏ÖÁêÜÊï∞ÊçÆÊõ¥Êñ∞ÂÆöÊó∂Âô®
            function cleanupDataUpdateInterval() {
                if (dataUpdateInterval) {
                    clearInterval(dataUpdateInterval);
                    dataUpdateInterval = null;
                }
            }

            // ÊµãËØïREST API
            async function testRESTAPI() {
                log('info', 'Ê≠£Âú®ÊµãËØïREST API...');
                updateRESTStatus('connecting', 'ÊµãËØï‰∏≠...');

                const startTime = Date.now();

                try {
                    const response = await fetch('https://api.binance.com/api/v3/ticker/24hr?symbols=["BTCUSDT","ETHUSDT","BNBUSDT","SOLUSDT","XRPUSDT"]');
                    const data = await response.json();

                    const responseTime = Date.now() - startTime;

                    if (response.ok && data.length > 0) {
                        log('success', `REST APIÊµãËØïÊàêÂäüÔºåÂìçÂ∫îÊó∂Èó¥: ${responseTime}ms`);
                        updateRESTStatus('connected', 'Ê≠£Â∏∏');

                        data.forEach(item => {
                            processPriceData(item, 'REST API');
                        });

                        document.getElementById('restResponseTime').textContent = responseTime + 'ms';
                        document.getElementById('restLastTest').textContent = new Date().toLocaleTimeString();

                        stats.successCount++;
                        updateStats();
                    } else {
                        throw new Error('APIÂìçÂ∫îÂºÇÂ∏∏');
                    }
                } catch (error) {
                    log('error', 'REST APIÊµãËØïÂ§±Ë¥•: ' + error.message);
                    updateRESTStatus('disconnected', 'Â§±Ë¥•');
                    stats.errorCount++;
                    updateStats();
                }
            }

            // Â§ÑÁêÜ‰ª∑Ê†ºÊï∞ÊçÆ
            function processPriceData(data, source) {
                const symbol = data.s ? data.s.toLowerCase() : data.symbol.toLowerCase();
                const price = data.c ? parseFloat(data.c) : parseFloat(data.lastPrice);
                const change = data.P ? parseFloat(data.P) : parseFloat(data.priceChangePercent);

                const symbolMap = {
                    'btcusdt': 'btc',
                    'ethusdt': 'eth',
                    'bnbusdt': 'bnb',
                    'solusdt': 'sol',
                    'xrpusdt': 'xrp'
                };

                const coin = symbolMap[symbol];
                if (coin) {
                    const oldPrice = priceData[coin].price;
                    const oldUpdateTime = priceData[coin].updateTime;

                    priceData[coin] = {
                        price: price,
                        change: change,
                        source: source,
                        updateTime: Date.now(),
                        frequency: oldUpdateTime ? Math.round((Date.now() - oldUpdateTime) / 1000) : 0
                    };

                    updatePriceDisplay(coin, oldPrice);
                    stats.dataUpdateCount++;
                    stats.successCount++;
                    updateStats();
                }
            }

            // Êõ¥Êñ∞‰ª∑Ê†ºÊòæÁ§∫
            function updatePriceDisplay(coin, oldPrice) {
                const priceElement = document.getElementById(coin + 'Price');
                const changeElement = document.getElementById(coin + 'Change');
                const updateElement = document.getElementById(coin + 'Update');
                const sourceElement = document.getElementById(coin + 'Source');
                const frequencyElement = document.getElementById(coin + 'Frequency');

                if (priceElement && changeElement && updateElement && sourceElement && frequencyElement) {
                    const data = priceData[coin];

                    // ‰ª∑Ê†ºÂä®Áîª
                    if (data.price > oldPrice) {
                        priceElement.classList.add('price-up');
                        setTimeout(() => priceElement.classList.remove('price-up'), 500);
                    } else if (data.price < oldPrice) {
                        priceElement.classList.add('price-down');
                        setTimeout(() => priceElement.classList.remove('price-down'), 500);
                    }

                    priceElement.textContent = '$' + data.price.toLocaleString('en-US', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });

                    changeElement.textContent = (data.change >= 0 ? '+' : '') + data.change.toFixed(2) + '%';
                    changeElement.style.color = data.change >= 0 ? '#00ff88' : '#ff4757';

                    updateElement.textContent = new Date(data.updateTime).toLocaleTimeString();
                    sourceElement.textContent = data.source;
                    frequencyElement.textContent = data.frequency + 's';
                }
            }

            // Êñ≠ÂºÄWebSocketËøûÊé•
            function disconnectWebSocket() {
                if (ws) {
                    ws.close(1000, 'Áî®Êà∑‰∏ªÂä®Êñ≠ÂºÄ');
                    log('info', 'Áî®Êà∑‰∏ªÂä®Êñ≠ÂºÄWebSocketËøûÊé•');
                }
            }

            // Âº∫Âà∂ÈáçËøû
            function forceReconnect() {
                log('info', 'Âº∫Âà∂ÈáçËøûWebSocket');
                if (ws) {
                    ws.close();
                }
                reconnectAttempts = 0;
                setTimeout(() => {
                    connectWebSocket();
                }, 1000);
            }

            // Ê∏ÖÁêÜWebSocketËøûÊé•
            function cleanupWebSocket() {
                if (ws) {
                    ws.close();
                    ws = null;
                }
                cleanupHealthCheck();
                cleanupDataUpdateInterval();
                if (reconnectTimeout) {
                    clearTimeout(reconnectTimeout);
                    reconnectTimeout = null;
                }
            }

            // Êõ¥Êñ∞WebSocketÁä∂ÊÄÅ
            function updateWSStatus(status, text) {
                const indicator = document.getElementById('wsStatusIndicator');
                const statusText = document.getElementById('wsStatusText');
                const connectTime = document.getElementById('wsConnectTime');

                indicator.className = 'status-indicator ' + status;
                statusText.textContent = text;

                if (status === 'connected') {
                    connectTime.textContent = new Date(connectionStartTime).toLocaleTimeString();
                }
            }

            // Êõ¥Êñ∞ËøûÊé•Êó∂Èïø
            function updateConnectionDuration() {
                if (isConnected && connectionStartTime) {
                    const duration = Math.floor((Date.now() - connectionStartTime) / 1000);
                    document.getElementById('wsDuration').textContent = duration + 's';
                }
            }

            // Êõ¥Êñ∞REST APIÁä∂ÊÄÅ
            function updateRESTStatus(status, text) {
                const indicator = document.getElementById('restStatusIndicator');
                const statusText = document.getElementById('restStatusText');

                indicator.className = 'status-indicator ' + status;
                statusText.textContent = text;
            }

            // Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆ
            function updateStats() {
                document.getElementById('connectionCount').textContent = stats.connectionCount;
                document.getElementById('disconnectCount').textContent = stats.disconnectCount;
                document.getElementById('reconnectCount').textContent = stats.reconnectCount;
                document.getElementById('dataUpdateCount').textContent = stats.dataUpdateCount;

                // ËÆ°ÁÆóÊàêÂäüÁéá
                const totalRequests = stats.successCount + stats.errorCount;
                const successRate = totalRequests > 0 ? ((stats.successCount / totalRequests) * 100).toFixed(1) : '0.0';

                document.getElementById('successRate').textContent = successRate + '%';
            }

            // ÂêØÂä®ËøêË°åÊó∂Èó¥ËÆ°Êï∞Âô®
            function startUptimeCounter() {
                const startTime = Date.now();
                uptimeInterval = setInterval(() => {
                    const uptime = Math.floor((Date.now() - startTime) / 1000);
                    document.getElementById('uptime').textContent = uptime + 's';
                }, 1000);
            }

            // Ê∑ªÂä†Êó•Âøó
            function log(level, message) {
                const logContainer = document.getElementById('logContainer');
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry log-${level}`;
                logEntry.textContent = `[${timestamp}] ${message}`;

                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;

                // ÈôêÂà∂Êó•ÂøóÊù°Êï∞
                while (logContainer.children.length > 100) {
                    logContainer.removeChild(logContainer.firstChild);
                }
            }

            // Ê∏ÖÁ©∫Êó•Âøó
            function clearLog() {
                document.getElementById('logContainer').innerHTML = '';
                log('info', 'Êó•ÂøóÂ∑≤Ê∏ÖÁ©∫');
            }

            // ÊòæÁ§∫ÈÄöÁü•
            function showNotification(message, type) {
                log(type, message);
            }

            // ÂêØÂä®Â§áÁî®Êï∞ÊçÆÊ∫ê
            function startBackupDataSource() {
                log('info', 'ÂêØÂä®Â§áÁî®Êï∞ÊçÆÊ∫ê');
                fetchPriceFromAPI();
                setInterval(fetchPriceFromAPI, 30000);
            }

            // Â§áÁî®Êï∞ÊçÆÊ∫ê
            async function fetchPriceFromAPI() {
                try {
                    const response = await fetch('https://api.binance.com/api/v3/ticker/24hr?symbols=["BTCUSDT","ETHUSDT","BNBUSDT","SOLUSDT","XRPUSDT"]');
                    const data = await response.json();

                    data.forEach(item => {
                        processPriceData(item, 'REST API');
                    });

                    log('info', 'REST APIÊï∞ÊçÆÊõ¥Êñ∞ÊàêÂäü');
                } catch (error) {
                    log('error', 'REST APIËé∑ÂèñÊï∞ÊçÆÂ§±Ë¥•: ' + error.message);
                }
            }

            // È°µÈù¢Âç∏ËΩΩÊó∂Ê∏ÖÁêÜ
            window.addEventListener('beforeunload', function () {
                cleanupWebSocket();
                if (uptimeInterval) {
                    clearInterval(uptimeInterval);
                }
            });
        </script>
    </body>

</html>
